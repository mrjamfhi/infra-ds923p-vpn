#!/bin/bash
# VPN Connection Monitor
# Checks VPN status, logs events, and sends DSM notifications
#
# Add to cron: */5 * * * * {{ vpn_config_dir }}/vpn-monitor.sh
#
# Generated by pod-synology-vpn

LOG_FILE="{{ vpn_config_dir }}/vpn-monitor.log"
STATE_FILE="{{ vpn_config_dir }}/.vpn-state"

# Get current state
if ip addr show tun0 > /dev/null 2>&1; then
    CURRENT_STATE="connected"
else
    CURRENT_STATE="disconnected"
fi

# Get previous state (default to unknown)
PREVIOUS_STATE=$(cat "$STATE_FILE" 2>/dev/null || echo "unknown")

# Log current state
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

if [ "$CURRENT_STATE" = "connected" ]; then
    echo "$TIMESTAMP VPN: Connected" >> "$LOG_FILE"
else
    echo "$TIMESTAMP VPN: DISCONNECTED!" >> "$LOG_FILE"
fi

# Send notification on state CHANGE only (avoid spam)
if [ "$CURRENT_STATE" != "$PREVIOUS_STATE" ]; then
    if [ "$CURRENT_STATE" = "disconnected" ]; then
        # VPN just disconnected - send alert
        synodsmnotify @administrators "VPN Alert" "ProtonVPN connection LOST! Kill switch may be blocking traffic."
        echo "$TIMESTAMP NOTIFICATION: Disconnect alert sent" >> "$LOG_FILE"
    elif [ "$CURRENT_STATE" = "connected" ] && [ "$PREVIOUS_STATE" = "disconnected" ]; then
        # VPN reconnected - send recovery notice
        synodsmnotify @administrators "VPN Restored" "ProtonVPN connection restored."
        echo "$TIMESTAMP NOTIFICATION: Reconnect notice sent" >> "$LOG_FILE"
    fi
fi

# Save current state
echo "$CURRENT_STATE" > "$STATE_FILE"

# Keep log file from growing too large (last 1000 lines)
tail -1000 "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
