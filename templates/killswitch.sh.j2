#!/bin/bash
# ProtonVPN Kill Switch for Synology
# Blocks all outbound traffic except through VPN (tun0)
#
# Generated by pod-synology-vpn
#
# NOTE: Does NOT flush FORWARD chain to preserve Docker's rules

# Flush INPUT/OUTPUT only (not FORWARD - Docker needs its rules)
iptables -F OUTPUT
iptables -F INPUT

# Allow loopback
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT

# Allow established connections
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow local network traffic
iptables -A OUTPUT -d {{ local_network_cidr }} -j ACCEPT
iptables -A INPUT -s {{ local_network_cidr }} -j ACCEPT

# Allow Docker bridge networks
# Docker uses various ranges: 172.16.0.0/12 and 192.168.0.0/16
iptables -A OUTPUT -d 172.16.0.0/12 -j ACCEPT
iptables -A INPUT -s 172.16.0.0/12 -j ACCEPT
iptables -A OUTPUT -d 192.168.0.0/16 -j ACCEPT
iptables -A INPUT -s 192.168.0.0/16 -j ACCEPT

# Add FORWARD rules for Docker containers to reach local network
# Insert at position 1 to ensure they're processed before any DROP
iptables -C FORWARD -s 172.16.0.0/12 -d {{ local_network_cidr }} -j ACCEPT 2>/dev/null || \
    iptables -I FORWARD 1 -s 172.16.0.0/12 -d {{ local_network_cidr }} -j ACCEPT
iptables -C FORWARD -s {{ local_network_cidr }} -d 172.16.0.0/12 -j ACCEPT 2>/dev/null || \
    iptables -I FORWARD 1 -s {{ local_network_cidr }} -d 172.16.0.0/12 -j ACCEPT
iptables -C FORWARD -s 192.168.0.0/16 -d {{ local_network_cidr }} -j ACCEPT 2>/dev/null || \
    iptables -I FORWARD 1 -s 192.168.0.0/16 -d {{ local_network_cidr }} -j ACCEPT
iptables -C FORWARD -s {{ local_network_cidr }} -d 192.168.0.0/16 -j ACCEPT 2>/dev/null || \
    iptables -I FORWARD 1 -s {{ local_network_cidr }} -d 192.168.0.0/16 -j ACCEPT

# Allow traffic through VPN interface
iptables -A OUTPUT -o tun0 -j ACCEPT
iptables -A INPUT -i tun0 -j ACCEPT

# Allow VPN connection establishment (UDP 1194 or TCP 443)
iptables -A OUTPUT -p udp --dport 1194 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT

# Block everything else (OUTPUT only - FORWARD handled by Docker)
iptables -A OUTPUT -j DROP

echo "Kill switch enabled - all non-VPN traffic blocked"
echo "Docker networks (172.16.0.0/12, 192.168.0.0/16) and local network ({{ local_network_cidr }}) allowed"
echo "Note: Docker FORWARD rules preserved"
