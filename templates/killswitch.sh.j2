#!/bin/bash
# ProtonVPN Kill Switch for Synology
# Blocks all outbound traffic except through VPN (tun0)
#
# Generated by pod-synology-vpn

# Flush existing rules
iptables -F OUTPUT
iptables -F INPUT
iptables -F FORWARD

# Allow loopback
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT

# Allow established connections
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow local network traffic
iptables -A OUTPUT -d {{ local_network_cidr }} -j ACCEPT
iptables -A INPUT -s {{ local_network_cidr }} -j ACCEPT

# Allow Docker bridge networks (172.16.0.0/12 covers all Docker defaults)
iptables -A OUTPUT -d 172.16.0.0/12 -j ACCEPT
iptables -A INPUT -s 172.16.0.0/12 -j ACCEPT

# Allow Docker containers to reach local network (FORWARD chain)
iptables -A FORWARD -s 172.16.0.0/12 -d {{ local_network_cidr }} -j ACCEPT
iptables -A FORWARD -s {{ local_network_cidr }} -d 172.16.0.0/12 -j ACCEPT

# Allow traffic through VPN interface
iptables -A OUTPUT -o tun0 -j ACCEPT
iptables -A INPUT -i tun0 -j ACCEPT

# Allow VPN connection establishment (UDP 1194 or TCP 443)
iptables -A OUTPUT -p udp --dport 1194 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT

# Block everything else
iptables -A OUTPUT -j DROP

echo "Kill switch enabled - all non-VPN traffic blocked"
echo "Docker networks (172.16.0.0/12) and local network ({{ local_network_cidr }}) allowed"
